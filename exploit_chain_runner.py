from datetime import datetime
import os

results = []

def analyze_chain(files):
    chain = []

    found = {
        "xss": False,
        "jwt": False,
        "creds": False,
        "priv_esc": False,
        "loot": False,
    }

    for file in files:
        try:
            with open(file, "r", errors="ignore") as f:
                content = f.read().lower()
                if "xss" in content or "<script>" in content:
                    found["xss"] = True
                if "jwt" in content or "eyj" in content:
                    found["jwt"] = True
                if "access_key" in content or "secret_key" in content:
                    found["creds"] = True
                if "privilege" in content or "iam:" in content:
                    found["priv_esc"] = True
                if "password" in content or "token" in content:
                    found["loot"] = True
        except Exception as e:
            chain.append(f"Error reading {file}: {str(e)}")

    if found["xss"] and found["jwt"]:
        chain.append("Reflected XSS ➜ Stolen JWT ➜ Session Replay")
    if found["creds"] and found["priv_esc"]:
        chain.append("AWS Creds ➜ Privilege Escalation ➜ Full Access")
    if found["loot"]:
        chain.append("Sensitive Loot ➜ Post-exploitation Access or Persistence")

    if not chain:
        chain.append("No chainable paths found — manual analysis may be required.")

    return chain

def run_exploit_chain_runner():
    print("\n--- Exploit Chain Runner ---")
    files_input = input("Enter comma-separated paths to previous results: ").strip()
    files = [f.strip() for f in files_input.split(",") if os.path.isfile(f.strip())]

    if not files:
        print("[!] No valid files provided.")
        return

    paths = analyze_chain(files)
    results.append({
        "files_analyzed": files,
        "chains": paths,
        "timestamp": datetime.utcnow().isoformat()
    })

    with open("exploit_chain_results.txt", "w") as f:
        for r in results:
            f.write(str(r) + "\n")

    print("\n[+] Chain analysis complete. Results saved to exploit_chain_results.txt.")

